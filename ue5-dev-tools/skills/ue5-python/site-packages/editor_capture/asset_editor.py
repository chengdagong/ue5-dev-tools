# editor_capture/asset_editor.py
# Asset editor operations for UE5
#
# Provides functions to open, close, and manage asset editors in UE5.
#
# Usage:
#   from editor_capture import asset_editor
#   asset_editor.open_asset_editor("/Game/Blueprints/BP_MyActor")
#   asset_editor.close_asset_editor("/Game/Blueprints/BP_MyActor")
#   asset_editor.close_all_asset_editors()

import unreal
import os


# ============================================
# Internal Helpers
# ============================================

def _load_asset(asset_path, expected_type=None):
    """
    Load and validate an asset.

    Args:
        asset_path: The asset path to load
        expected_type: Optional type to validate against (e.g., unreal.Blueprint)

    Returns:
        tuple: (asset, error_message) - asset is None if failed
    """
    if not unreal.EditorAssetLibrary.does_asset_exist(asset_path):
        return None, f"Asset does not exist: {asset_path}"

    asset = unreal.EditorAssetLibrary.load_asset(asset_path)
    if not asset:
        return None, f"Failed to load asset: {asset_path}"

    if expected_type and not isinstance(asset, expected_type):
        return None, f"Asset is not a {expected_type.__name__}: {asset_path}"

    return asset, None


def _get_editor_subsystem():
    """
    Get the AssetEditorSubsystem.

    Returns:
        tuple: (subsystem, error_message) - subsystem is None if failed
    """
    subsystem = unreal.get_editor_subsystem(unreal.AssetEditorSubsystem)
    if not subsystem:
        return None, "Failed to get AssetEditorSubsystem"
    return subsystem, None


def _ensure_directory(path):
    """Ensure the directory for a file path exists."""
    output_dir = os.path.dirname(path)
    if output_dir and not os.path.exists(output_dir):
        os.makedirs(output_dir)


# ============================================
# Asset Editor Functions
# ============================================

def open_asset_editor(asset_path):
    """
    Open the editor for a single asset.

    Args:
        asset_path: The asset path (e.g., "/Game/Blueprints/BP_MyBlueprint")

    Returns:
        bool: True if successful, False otherwise
    """
    asset, error = _load_asset(asset_path)
    if error:
        unreal.log_error(f"[ERROR] {error}")
        return False

    subsystem, error = _get_editor_subsystem()
    if error:
        unreal.log_error(f"[ERROR] {error}")
        return False

    subsystem.open_editor_for_assets([asset])
    unreal.log(f"[OK] Opened editor for: {asset_path}")
    return True


def open_blueprint_editor(blueprint_path):
    """
    Open the Blueprint editor for a Blueprint asset.

    Args:
        blueprint_path: The Blueprint asset path

    Returns:
        bool: True if successful, False otherwise
    """
    asset, error = _load_asset(blueprint_path, unreal.Blueprint)
    if error:
        unreal.log_error(f"[ERROR] {error}")
        return False

    subsystem, error = _get_editor_subsystem()
    if error:
        unreal.log_error(f"[ERROR] {error}")
        return False

    subsystem.open_editor_for_assets([asset])
    unreal.log(f"[OK] Opened Blueprint editor for: {blueprint_path}")
    return True


def open_multiple_asset_editors(asset_paths):
    """
    Open editors for multiple assets at once.

    Args:
        asset_paths: List of asset paths to open

    Returns:
        dict: {"success": [paths], "failed": [paths]}
    """
    results = {"success": [], "failed": []}

    if not asset_paths:
        unreal.log_warning("[WARNING] No asset paths provided")
        return results

    assets_to_open = []
    for path in asset_paths:
        asset, error = _load_asset(path)
        if error:
            unreal.log_error(f"[ERROR] {error}")
            results["failed"].append(path)
        else:
            assets_to_open.append((path, asset))

    if assets_to_open:
        subsystem, error = _get_editor_subsystem()
        if subsystem:
            subsystem.open_editor_for_assets([asset for _, asset in assets_to_open])
            for path, _ in assets_to_open:
                unreal.log(f"[OK] Opened editor for: {path}")
                results["success"].append(path)
        else:
            unreal.log_error(f"[ERROR] {error}")
            for path, _ in assets_to_open:
                results["failed"].append(path)

    unreal.log("=" * 50)
    unreal.log(f"[SUMMARY] Opened: {len(results['success'])}, Failed: {len(results['failed'])}")
    return results


def close_asset_editor(asset_path):
    """
    Close the editor for a specific asset.

    Args:
        asset_path: The asset path to close

    Returns:
        bool: True if successful, False otherwise
    """
    asset, error = _load_asset(asset_path)
    if error:
        unreal.log_error(f"[ERROR] {error}")
        return False

    subsystem, error = _get_editor_subsystem()
    if error:
        unreal.log_error(f"[ERROR] {error}")
        return False

    subsystem.close_all_editors_for_asset(asset)
    unreal.log(f"[OK] Closed editor for: {asset_path}")
    return True


def close_all_asset_editors():
    """
    Close all open asset editors.

    Returns:
        bool: True if successful, False otherwise
    """
    subsystem, error = _get_editor_subsystem()
    if error:
        unreal.log_error(f"[ERROR] {error}")
        return False

    subsystem.close_all_asset_editors()
    unreal.log("[OK] Closed all asset editors")
    return True


def load_asset(asset_path, expected_type=None):
    """
    Load an asset by path.

    Args:
        asset_path: The asset path to load
        expected_type: Optional type to validate against

    Returns:
        The loaded asset, or None if failed
    """
    asset, error = _load_asset(asset_path, expected_type)
    if error:
        unreal.log_error(f"[ERROR] {error}")
        return None
    return asset


def asset_exists(asset_path):
    """
    Check if an asset exists at the given path.

    Args:
        asset_path: The asset path to check

    Returns:
        bool: True if asset exists, False otherwise
    """
    return unreal.EditorAssetLibrary.does_asset_exist(asset_path)
