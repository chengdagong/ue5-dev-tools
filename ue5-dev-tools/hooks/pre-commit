#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Pre-commit hook to automatically increment version in plugin.json
Increments the patch version (0.0.1) on every commit
"""

import json
import sys
import io
import os
import subprocess
from pathlib import Path

# Ensure UTF-8 output on all platforms
if sys.version_info[0] >= 3:
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

# Get the git repository root
git_root = Path(__file__).parent.parent.parent
plugin_json_path = git_root / "ue5-dev-tools" / ".claude-plugin" / "plugin.json"

# Files that don't require version bumping (auxiliary/meta files)
AUXILIARY_FILES = {
    '.gitignore',
    '.gitattributes',
    '.editorconfig',
    '.github',
    'README.md',
    'LICENSE',
    '.vscode',
    '.idea',
    '.DS_Store',
    '*.log',
    '.env',
    '.env.local',
}

def is_auxiliary_file(file_path):
    """Check if a file is an auxiliary/meta file that doesn't require version bumping"""
    path_obj = Path(file_path)

    # Check against exact filename matches and directories
    if path_obj.name in AUXILIARY_FILES or path_obj.name.lstrip('.') in AUXILIARY_FILES:
        return True

    # Check against pattern matches (e.g., *.log)
    for pattern in AUXILIARY_FILES:
        if '*' in pattern:
            import fnmatch
            if fnmatch.fnmatch(path_obj.name, pattern):
                return True

    # Check if any parent directory is in auxiliary files (e.g., .github, .vscode)
    for part in path_obj.parts:
        if part in AUXILIARY_FILES:
            return True

    return False

def get_staged_files():
    """Get list of staged files in the current commit"""
    try:
        # Get the list of staged files using git diff --cached
        result = subprocess.run(
            ['git', 'diff', '--cached', '--name-only'],
            capture_output=True,
            text=True,
            cwd=str(git_root)
        )
        if result.returncode == 0:
            return result.stdout.strip().split('\n') if result.stdout.strip() else []
    except Exception as e:
        print(f"Warning: Could not get staged files: {e}")
    return []

def should_bump_version():
    """Check if version should be bumped based on staged files"""
    staged_files = get_staged_files()

    if not staged_files:
        return False

    # Check if there are any non-auxiliary files
    for file_path in staged_files:
        if file_path and not is_auxiliary_file(file_path):
            return True

    # All staged files are auxiliary files
    return False

def increment_version(version_str):
    """Increment the version with rollover (x.y.9 -> x.y+1.0, x.9.9 -> x+1.0.0)"""
    parts = version_str.split('.')
    if len(parts) != 3:
        print(f"Warning: Unexpected version format '{version_str}', expected x.y.z")
        return version_str

    try:
        major = int(parts[0])
        minor = int(parts[1])
        patch = int(parts[2])
    except ValueError:
        print(f"Warning: Cannot parse version '{version_str}' as integers")
        return version_str

    # Increment with rollover
    patch += 1
    if patch > 9:
        patch = 0
        minor += 1
        if minor > 9:
            minor = 0
            major += 1

    return f"{major}.{minor}.{patch}"

def main():
    # Check if version bump is needed based on staged files
    if not should_bump_version():
        print("ℹ Skipping version bump (only auxiliary files changed)")
        return 0

    # Check if plugin.json exists
    if not plugin_json_path.exists():
        print(f"Warning: {plugin_json_path} not found, skipping version increment")
        return 0

    # Read plugin.json
    try:
        with open(plugin_json_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
    except Exception as e:
        print(f"Error reading {plugin_json_path}: {e}")
        return 1

    # Get current version
    current_version = data.get('version', '0.0.0')

    # Increment version
    new_version = increment_version(current_version)

    if new_version == current_version:
        # No change needed or error occurred
        return 0

    # Update version
    data['version'] = new_version

    # Write back to file with proper formatting
    try:
        with open(plugin_json_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, indent=4, ensure_ascii=False)
            f.write('\n')  # Add trailing newline
    except Exception as e:
        print(f"Error writing {plugin_json_path}: {e}")
        return 1

    # Stage the modified plugin.json
    relative_path = plugin_json_path.relative_to(git_root)
    os.system(f'git add "{relative_path}"')

    print(f"✓ Version bumped: {current_version} → {new_version}")

    return 0

if __name__ == '__main__':
    sys.exit(main())
