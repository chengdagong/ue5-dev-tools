#!/usr/bin/env python
"""
Pre-commit hook to automatically increment version in plugin.json
Increments the patch version (0.0.1) on every commit
"""

import json
import sys
import os
from pathlib import Path

# Get the git repository root
git_root = Path(__file__).parent.parent.parent
plugin_json_path = git_root / "ue5-dev-tools" / ".claude-plugin" / "plugin.json"

def increment_version(version_str):
    """Increment the patch version (x.y.z -> x.y.z+1)"""
    parts = version_str.split('.')
    if len(parts) != 3:
        print(f"Warning: Unexpected version format '{version_str}', expected x.y.z")
        return version_str

    major, minor, patch = parts
    try:
        new_patch = int(patch) + 1
        return f"{major}.{minor}.{new_patch}"
    except ValueError:
        print(f"Warning: Cannot parse patch version '{patch}' as integer")
        return version_str

def main():
    # Check if plugin.json exists
    if not plugin_json_path.exists():
        print(f"Warning: {plugin_json_path} not found, skipping version increment")
        return 0

    # Read plugin.json
    try:
        with open(plugin_json_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
    except Exception as e:
        print(f"Error reading {plugin_json_path}: {e}")
        return 1

    # Get current version
    current_version = data.get('version', '0.0.0')

    # Increment version
    new_version = increment_version(current_version)

    if new_version == current_version:
        # No change needed or error occurred
        return 0

    # Update version
    data['version'] = new_version

    # Write back to file with proper formatting
    try:
        with open(plugin_json_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, indent=4, ensure_ascii=False)
            f.write('\n')  # Add trailing newline
    except Exception as e:
        print(f"Error writing {plugin_json_path}: {e}")
        return 1

    # Stage the modified plugin.json
    relative_path = plugin_json_path.relative_to(git_root)
    os.system(f'git add "{relative_path}"')

    print(f"✓ Version bumped: {current_version} → {new_version}")

    return 0

if __name__ == '__main__':
    sys.exit(main())
