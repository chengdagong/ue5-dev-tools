# asset_diagnostic/__main__.py
# Command line entry point for running diagnostics
# Usage: Execute this module in UE5 Python environment

import unreal
import sys

from .core import (
    AssetType,
    detect_asset_type,
    get_current_level_path,
    get_selected_assets,
)
from .diagnostics import get_diagnostic_for_type, get_supported_types


def print_help():
    """Print usage information."""
    unreal.log("")
    unreal.log("=" * 60)
    unreal.log("UE5 Asset Diagnostic Tool")
    unreal.log("=" * 60)
    unreal.log("")
    unreal.log("Usage:")
    unreal.log("  import asset_diagnostic")
    unreal.log("  asset_diagnostic.diagnose('/Game/Path/To/Asset')")
    unreal.log("")
    unreal.log("  # Or diagnose current level:")
    unreal.log("  asset_diagnostic.diagnose_current_level()")
    unreal.log("")
    unreal.log("  # Or diagnose selected assets:")
    unreal.log("  asset_diagnostic.diagnose_selected()")
    unreal.log("")
    unreal.log("Supported asset types:")
    for asset_type in get_supported_types():
        unreal.log(f"  - {asset_type.value}")
    unreal.log("")


def diagnose(asset_path: str = None):
    """
    Run diagnostics on an asset.

    Args:
        asset_path: Path to the asset. If None, diagnoses current level.

    Returns:
        DiagnosticResult or None if no diagnostic available
    """
    # If no path provided, try current level
    if asset_path is None:
        return diagnose_current_level()

    # Detect asset type
    asset_type = detect_asset_type(asset_path)

    unreal.log(f"[INFO] Asset: {asset_path}")
    unreal.log(f"[INFO] Detected type: {asset_type.value}")

    if asset_type == AssetType.UNKNOWN:
        unreal.log(f"[WARNING] Unknown asset type for: {asset_path}")
        unreal.log("[INFO] Supported types: " + ", ".join(t.value for t in get_supported_types()))
        return None

    # Get appropriate diagnostic
    diagnostic = get_diagnostic_for_type(asset_type)

    if diagnostic is None:
        unreal.log(f"[WARNING] No diagnostic available for type: {asset_type.value}")
        return None

    # Run diagnostic
    unreal.log(f"[INFO] Running {diagnostic.name}...")
    result = diagnostic.diagnose(asset_path)

    # Print report
    result.print_report()

    return result


def diagnose_current_level():
    """
    Run diagnostics on the currently open level.

    Returns:
        DiagnosticResult or None if no level is open
    """
    level_path = get_current_level_path()

    if not level_path:
        unreal.log("[WARNING] No level is currently open")
        return None

    unreal.log(f"[INFO] Diagnosing current level: {level_path}")

    # Level diagnostic
    diagnostic = get_diagnostic_for_type(AssetType.LEVEL)

    if diagnostic is None:
        unreal.log("[ERROR] No Level diagnostic available")
        return None

    result = diagnostic.diagnose(level_path)
    result.print_report()

    return result


def diagnose_selected():
    """
    Run diagnostics on assets selected in Content Browser.

    Returns:
        List of DiagnosticResult
    """
    selected = get_selected_assets()

    if not selected:
        unreal.log("[WARNING] No assets selected in Content Browser")
        return []

    unreal.log(f"[INFO] Found {len(selected)} selected assets")

    results = []
    for asset_path in selected:
        unreal.log(f"\n{'=' * 60}")
        result = diagnose(asset_path)
        if result:
            results.append(result)

    unreal.log(f"\n[INFO] Diagnosed {len(results)} assets")
    return results


def main():
    """Main entry point when run as module."""
    # Check for command line arguments (if supported)
    # In UE5 Python, sys.argv may not be available

    # Default: diagnose current level
    unreal.log("")
    unreal.log("#" * 60)
    unreal.log("#  UE5 ASSET DIAGNOSTIC")
    unreal.log("#" * 60)

    # Try to get selected assets first
    selected = get_selected_assets()
    if selected:
        unreal.log(f"[INFO] Diagnosing {len(selected)} selected asset(s)")
        for path in selected:
            diagnose(path)
    else:
        # Fall back to current level
        unreal.log("[INFO] No selection - diagnosing current level")
        diagnose_current_level()


if __name__ == "__main__":
    main()
